pipeline {
  agent { label 'aws-agent' }

  environment {
    APP_NAME = "tetris-backend"
    BUILD_DIR = "backend-artifacts"

    SONAR_HOST = "http://51.20.189.19:9000"
    SONAR_PROJECT_KEY = "tetris-backend"

    IMAGE_NAME = "tetris-backend"
    IMAGE_TAG = "${BUILD_NUMBER}"
    FULL_IMAGE = "${IMAGE_NAME}:${IMAGE_TAG}"

    AWS_REGION = "us-east-1"
    ECR_REPO = "101561167685.dkr.ecr.us-east-1.amazonaws.com/tetris-backend"
  }

  stages {

    stage('Build Backend') {
      steps {
        sh '''
        docker run --rm \
          -v $PWD:/app \
          -w /app \
          node:18-alpine \
          sh -c "npm install"

        rm -rf ${BUILD_DIR}
        mkdir -p ${BUILD_DIR}
        cp Dockerfile package.json server.js -r node_modules ${BUILD_DIR}/
        '''
      }
    }

    stage('OWASP Dependency Check (soft)') {
      steps {
        withCredentials([string(credentialsId: 'nvd-api-key', variable: 'NVD_KEY')]) {
          sh '''
          mkdir -p owasp-report
          docker run --rm \
            -v $WORKSPACE:/src \
            -v odc-data:/usr/share/dependency-check/data \
            owasp/dependency-check \
            --scan /src \
            --format HTML \
            --out /src/owasp-report \
            --nvdApiKey $NVD_KEY || true
          '''
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withCredentials([string(credentialsId: 'sonar-creds', variable: 'SONAR_TOKEN')]) {
          sh '''
          docker run --rm \
            --network host \
            -v $PWD:/usr/src \
            sonarsource/sonar-scanner-cli \
            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
            -Dsonar.sources=. \
            -Dsonar.host.url=${SONAR_HOST} \
            -Dsonar.login=$SONAR_TOKEN || true
          '''
        }
      }
    }

    stage('Push Artifacts to Nexus') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'nexus-creds',
          usernameVariable: 'NEXUS_USER',
          passwordVariable: 'NEXUS_PASS')]) {

          sh '''
          zip -r backend-build.zip ${BUILD_DIR}

          curl -u $NEXUS_USER:$NEXUS_PASS \
            --upload-file backend-build.zip \
            http://51.20.189.19:8081/repository/raw-hosted/backend-build-${BUILD_NUMBER}.zip
          '''
        }
      }
    }

    stage('Docker Build') {
      steps {
        sh 'docker build -t ${FULL_IMAGE} .'
      }
    }

    stage('Trivy Image Scan (soft)') {
      steps {
        sh '''
        trivy image --scanners vuln ${FULL_IMAGE} \
          --format table \
          --output trivy-image.txt || true
        '''
      }
    }

    stage('Push to AWS ECR') {
      steps {
        sh '''
        aws ecr get-login-password --region $AWS_REGION | \
          docker login --username AWS --password-stdin $ECR_REPO

        docker tag ${FULL_IMAGE} ${ECR_REPO}:${BUILD_NUMBER}
        docker push ${ECR_REPO}:${BUILD_NUMBER}
        '''
      }
    }

    stage('Archive Reports') {
      steps {
        archiveArtifacts artifacts: 'trivy-image.txt, owasp-report/**', fingerprint: true
      }
    }
  }

  post {
    always {
      echo "Backend Pipeline Finished"
    }
  }
}
